<DOCTYPE html>
    <html lang="en" dir="ltr">

    <head>
        <meta charset="utf-8">
        <title>GPS Tracker</title>
        <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
        <link rel="stylesheet" href="Historicos.css">

        <!-- Css de leaflet-->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
            integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
            crossorigin="" />

        <!-- JS de leaflet-->
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
            integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
            crossorigin=""></script>

        <!-- JS de jquery-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

    </head>

    <body onload="historic();">
        <header>
            <div class="dateinit">
                <h2>Seleccione fecha inicio</h2>
                <input type="date" id="start" min='2000-01-01'>
                <br>
                <h2>Seleccione hora inicio</h2>
                <input type="time" id="hstart">
            </div>
            <p>
                <br>
                <br>
                <br>
                <button id="serch" class="button3">Buscar</button>
                <br>
                <br>
                <br>
            </p>

            <div class="datefinish">
                <h2>Seleccione fecha fin</h2>
                <input type="date" id="finish" min='2000-01-01'>
                <br>
                <h2>Seleccione hora fin</h2>
                <input type="time" id="hfinish">
            </div>


        </header>
        <div class="div1">
            <div>

            </div>
            <div>

            </div>
        </div>
        <div id="formarea" style="display: none;">
            <label for="area">Área</label>
            <input type="range" id="area" name="area" min="1" max="10">
            <br>
            <br>
            <label for="searchedmarkers">Markers inside circle</label>
            <input type="range" id="searchedmarkers" name="searchedmarkers" min="1">
        </div>
        <div id="map" class="mapa"></div>

        <div class="piepagin">
            <nav class="histo">
                <a href="index.html" class="button3">Volver a ubicación en tiempo real</a>
            </nav>
        </div>

        <script type="text/javascript">
            var date = new Date();
            var data = [null, null];
            data.length = 0;

            ini_fec = document.getElementById('start');
            fin_fec = document.getElementById('finish');

            ini_hor = document.getElementById('hstart');
            fin_hor = document.getElementById('hfinish');


            var dayT = date.toISOString().slice(0, 10);

            fin_fec.max = dayT;
            ini_fec.max = dayT;

            ini_fec.value = dayT;
            fin_fec.value = dayT;

            hours = date.getHours();
            minu = date.getMinutes();
            var horaT = hours + ':' + minu;

            ini_hor.value = horaT;
            fin_hor.value = horaT;

            //calendario funcional
            ini_fec.addEventListener('click', function () {
                ini_fec.max = fin_fec.value;
            });

            fin_fec.addEventListener('click', function () {
                fin_fec.min = ini_fec.value;
            });


            document.getElementById("serch").onclick = function () { routine() };

            //área
            area_drag = document.getElementById('area');
            area_drag.addEventListener('click', function () {
                if (popLast != null) {
                    AreaUbicacionDrag();
                    InsideCircle();
                }
            });
            //markers search
            markers_drag = document.getElementById('searchedmarkers');
            markers_drag.addEventListener('click', function () {
                AreaUbicacion();
                setTimeout(() => { InsideCircle(); }, 100);

            });

            function sendT() {

                //console.log(fin_fec.value);
                //console.log(ini_fec.value);

                var fechaini = ini_fec.value;
                var fechafin = fin_fec.value;
                var horaini = ini_hor.value;
                var horafin = fin_hor.value;

                $.ajax({
                    url: 'historicos.php',
                    type: 'post',
                    data: {
                        fechaini: fechaini,
                        fechafin: fechafin,
                        horaini: horaini,
                        horafin: horafin
                    }

                }).done(function (res) {
                    data = JSON.parse(res);
                })
            }

            var container = L.DomUtil.get("map"); //Mapa contendor

            if (container != null) {
                container._leaflet_id = null;
            }

            if (map) {
                map.invalidateSize(); // Si hay un mapa, lo elimina para recrearlo y que se pueda cambiar actualmente la posición ##
            }
            var marker = null;
            var L = window.L;
            var trig = 1;

            var map = L.map("map").
                setView([10.99574, -74.79326],
                    16);

            L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data &copy; <a href="https://github.com/MSDR2022/Pagina2022">GPS Tracker</a>',
                maxZoom: 17
            }).addTo(map);

            L.control.scale().addTo(map);

            function historic() {
                if (data.length != 0) {
                    AreaUbicacion();
                }
                window.linearray = [];
                var LongitudHist = [];
                var LatitudHist = [];
                var FechaHist = [];
                if (window.data[0] == null && window.data[1] == null) { }
                else {
                    //console.log(linearray);
                    for (let i = 0; i < data.length; i++) {
                        LongitudHist.push(data[i].Longitud);
                        LatitudHist.push(data[i].Latitud);
                        FechaHist.push(data[i].Fecha);
                        window.linearray.push([data[i].Latitud, data[i].Longitud]);
                    }

                    // console.log("linearray 2" + linearray);
                    for (let j = 1; j < 3; j++) {
                        if (marker == null) {
                            marker = L.marker([data[data.length - 1].Latitud, data[data.length - 1].Longitud]).addTo(map).bindPopup('<b>' + data[data.length - 1].Fecha + '</b>' + '<br />' + data[data.length - 1].Latitud + ' ' + data[data.length - 1].Longitud).openPopup();

                        } else {
                            marker.getPopup().setContent('<b>' + data[data.length - 1].Fecha + '</b>' + '<br />' + data[data.length - 1].Latitud + ' ' + data[data.length - 1].Longitud);
                            marker.setLatLng([data[data.length - 1].Latitud, data[data.length - 1].Longitud]);
                            //Polilinea
                            var polyline = L.polyline(window.linearray, { color: 'red' }).addTo(map);

                        }
                    }
                }

            }
            window.popLast = null;
            var popLocation = null;

            function AreaUbicacion() {
                if (data.length == 0) {
                    clearCircle();
                } else {
                map.on('click', function (e) {
                    if (popLast != null) {
                        map.removeLayer(window.circle);
                    }
                    var popLocation = e.latlng;
                    window.circle = new L.circle(popLocation, { radius: area.value * 100 });
                    map.addLayer(window.circle)
                    window.popLast = popLocation;

                    setTimeout(() => { InsideCircle(); }, 100);

                });
            }
            }

            function AreaUbicacionDrag() {
                if (data.length == 0) {
                    clearCircle();
                } else {
                if (popLast != null) {
                    map.removeLayer(window.circle);
                }
                window.circle = new L.circle(popLast, { radius: area.value * 100 });
                map.addLayer(window.circle)

                setTimeout(() => { InsideCircle(); }, 100);
            }
        }

            function InsideCircle() {
                window.searchedtime = [];
                window.searchedarray = [];
                for (let i = 0; i < window.linearray.length - 1; i++) {
                    if (map.distance(window.linearray[i], window.circle._latlng) < area.value * 100) {
                        window.searchedtime.push(window.data[i].Fecha);
                        window.searchedarray.push(window.linearray[i]);
                    }
                }
                markers_drag.max = searchedarray.length - 1;
                InsideCircleMarkers();
            }

            function InsideCircleMarkers() {
                if (window.searchedarray.length != 0) {
                    marker.remove();
                    marker = L.marker(searchedarray[markers_drag.value]).addTo(map).bindPopup('<b>' + window.searchedtime[markers_drag.value] + '</b>' + '<br />' + searchedarray[markers_drag.value]).openPopup();
                } else {
                    marker.remove();
                }
            }

            function clearMap() {
                for (i in map._layers) {
                    if (map._layers[i]._path != undefined) {
                        try {
                            map.removeLayer(map._layers[i]);
                        }
                        catch (e) {
                            console.log("problem with " + e + map._layers[i]);
                        }
                    }
                }
            }

            function clearCircle() {
                map.removeLayer(window.circle);
                marker.remove();
            }

            function routine() {

                clearMap();
                sendT();
                setTimeout(() => {
                    if (data.length != 0) {
                        formarea.style.display = "block";
                    } else if (data.length == 0) {
                        formarea.style.display = "none";
                        clearCircle();
                    }
                }, 200);
                setTimeout(() => { historic(); }, 200);

            }
        </script>

    </body>

    </html>