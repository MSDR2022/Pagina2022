<DOCTYPE html>
  <html lang="en" dir="ltr">

  <head>
    <meta charset="utf-8">
    <title>GPS Tracker</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="PaginaDiseño.css">

    <!-- Css de leaflet-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
      integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
      crossorigin="" />

    <!-- JS de leaflet-->
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
      integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
      crossorigin=""></script>

    <!-- JS de leaflet.dialog-->
    <script src="Leaflet.Dialog.js"></script>

    <!-- JS de leaflet.EasyButton-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

  </head>

  <body onload="table();">

    <header>
      <div>
        <h2 class="titulo">Ubicación en Tiempo Real</h2>
      </div>
    </header>



    <div id="map" class="mapa"></div>
    <div class="piepagin">
      <nav class="histo">
        <a href="Historicos.html" class="button3">Consultar Históricos</a>
      </nav>
    </div>

    <script type="text/javascript">
      window.markerActual = "";
      var container = L.DomUtil.get("map"); //Mapa contendor

      if (container != null) {
        container._leaflet_id = null;
      }

      if (map) {
        map.invalidateSize(); // Si hay un mapa, lo elimina para recrearlo y que se pueda cambiar actualmente la posición ##
      }
      var marker = null;
      var L = window.L;
      var trig = 1;

      var map = L.map("map").
        setView(["10.1010101", "-74.80808088"],
          16);

      L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://github.com/MSDR2022/Pagina2022">GPS Tracker</a>',
        maxZoom: 17
      }).addTo(map);

      L.control.scale().addTo(map);
      var estadoCenterMark = "Seguir el vehículo 1";
      var stateSelectCar = L.easyButton({
        states: [{
          stateName: 'selectCar1',        // name the state
          icon: '<img src="/images/car1.png">',               // and define its properties
          title: 'Vehículo #1',      // like its title
          onClick: function (btn, map) {       // and its callback
            clearMap();
            var estadoCenterMark = "Seguir el vehículo 2";
            window.centerMarkbutton.textContent = estadoCenterMark;
            dialogBox();
            btn.state('selectCar2');    // change state on click
            polycolorline = "green";
          }
        }, {
          stateName: 'selectCar2',
          icon: '<img src="/images/car2.png">',
          title: 'Vehículo #2',
          onClick: function (btn, map) {
            clearMap();
            dialogBox();
            btn.state('selectCar3');
            polycolorline = "maroon";
          }
        }, {
          stateName: 'selectCar3',
          icon: '<img src="/images/car3.png">',
          title: 'Ambos vehículos',
          onClick: function (btn, map) {
            clearMap();
            var estadoCenterMark = "Seguir el vehículo 1";
            window.centerMarkbutton.textContent = estadoCenterMark;
            dialogBox();
            btn.state('selectCar1');
          }
        }]
      });
      stateSelectCar.addTo(map);

      var linearray = [];
      function table() {
        const xhttp = new XMLHttpRequest();  //creando el objeto para trabajar
        xhttp.onload = function () {

          var data = this.responseText
          data = JSON.parse(data);


          if (marker == null) {
            window.markerActual = '<b> <center>' + 'Vehículo 1' + '</center> </b>' + '<hr>' + '<b> <center>' + data.Fecha + '</center> </b>' + '<center>' + data.Latitud + ', ' + data.Longitud + '</center>' + '<b>';
            marker = L.marker([data.Latitud, data.Longitud]).addTo(map).bindPopup(window.markerActual);
            map.panTo(marker._latlng);
            dialogBox();

            if (trig == 1) {
              marker.getPopup().options.autoPan = false;
              map.setView([data.Latitud, data.Longitud], 16);
              trig = 2;
            } if (trig == 2) {
              marker.getPopup().options.autoPan = true;
            }

          } else {
            window.markerActual = '<b> <center>' + 'Vehículo 1' + '</center> </b>' + '<hr>' + '<b> <center>' + data.Fecha + '</center> </b>' + '<center>' + data.Latitud + ', ' + data.Longitud + '</center>' + '<b>';
            marker.getPopup().setContent(window.markerActual);
            if (estadoCenterMark == "Seguir el vehículo 1") {
            } else {
              map.panTo(marker._latlng);
            }
            marker.setLatLng([data.Latitud, data.Longitud]);
            //Polilinea
            linearray.push([data.Latitud, data.Longitud]);
            polyline = L.polyline(linearray, { color: 'green' }).addTo(map);

          }

        }

        xhttp.open("GET", "datadb.php");  // documento que estamos llamando
        xhttp.send();
      }

      setInterval(function () {   //creamos un intervalo para realizar el mismo request del archivo que genera la conexión con la base de datos
        table();
        dialogBox();
      }, 5000); // Cada 5 segundos

      function dialogBox() {
        var options = {
          size: [300, 150],
          anchor: [0, 0],
          position: "bottomright",
          initOpen: true
        }
        if (stateSelectCar._currentState.stateName == "selectCar1") {
          if (estadoCenterMark == "Seguir el vehículo 1") {
            markerCenterActual = window.markerActual + "<br />" + "<center>" + "<button class='button3' id='centerMark' onclick='centerMark();'>Seguir el vehículo 1</button>" + "</center>";
          } else {
            markerCenterActual = window.markerActual + "<br />" + "<center>" + "<button class='button3' id='centerMark' onclick='centerMark();'>Dejar de seguir el vehículo 1</button>" + "</center>";
          }
        } else if (stateSelectCar._currentState.stateName == "selectCar2") {
          if (estadoCenterMark == "Seguir el vehículo 2") {
            markerCenterActual = window.markerActual + "<br />" + "<center>" + "<button class='button3' id='centerMark' onclick='centerMark();'>Seguir el vehículo 2</button>" + "</center>";
          } else {
            markerCenterActual = window.markerActual + "<br />" + "<center>" + "<button class='button3' id='centerMark' onclick='centerMark();'>Dejar de seguir el vehículo 2</button>" + "</center>";
          }
        } else {
          // caso de ver los dos vehículos
        }

        if (window.dialog) {
          window.dialog.open();
          window.dialog.setContent(markerCenterActual);
        } else {
          window.dialog = L.control.dialog(options)
            .setContent(markerCenterActual)
            .addTo(map);
          dialog.freeze();
        }
      }

      function clearMap() {
        for (i in map._layers) {
          if (map._layers[i]._path != undefined) {
            try {
              map.removeLayer(map._layers[i]);
            }
            catch (e) {
              console.log("problem with " + e + map._layers[i]);
            }
          }
        }
      }

      function centerMark() {
        window.centerMarkbutton = document.getElementById('centerMark');
        if (stateSelectCar._currentState.stateName == "selectCar1") {
          if (estadoCenterMark == "Seguir el vehículo 1") {
            estadoCenterMark = "Dejar de seguir el vehículo 1";
          } else {
            estadoCenterMark = "Seguir el vehículo 1";
          }
        } else if (stateSelectCar._currentState.stateName == "selectCar2") {
          if (estadoCenterMark == "Seguir el vehículo 2") {
            estadoCenterMark = "Dejar de seguir el vehículo 2";
          } else {
            estadoCenterMark = "Seguir el vehículo 2";
          }
        } else {
          //codigo para cuando son los 2
        }
        window.centerMarkbutton.textContent = estadoCenterMark;
      }

    </script>

  </body>

  </html>