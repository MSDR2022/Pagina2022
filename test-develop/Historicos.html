<DOCTYPE html>
    <html lang="en" dir="ltr">

    <head>
        <meta charset="utf-8">
        <title>GPS Tracker</title>
        <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
        <link rel="stylesheet" href="Historicos.css">

        <!-- Css de leaflet-->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
            integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
            crossorigin="" />

        <!-- JS de leaflet-->
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
            integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
            crossorigin=""></script>

        <!-- JS de jquery-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

        <!-- JS de leaflet.dialog-->
        <script src="Leaflet.Dialog.js"></script>

        <!-- JS de leaflet.EasyButton-->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
        <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>


    </head>

    <body onload="historic();">
        <header>
            <div class="dateinit">
                <h2>Seleccione fecha inicio</h2>
                <input type="datetime-local" id="start" min='2022-01-01 00:00'>
                <h4 id="invalidinicial" style="color:red; float: right; margin-right:10%; display:none">✖</h4>
                <h4 id="invalidinicialtext" style="display: none">La hora inicial debe ser anterior a la hora final.
                </h4>
                <br>
            </div>
            <p>
                <br>
                <br>
                <br>
            </p>

            <div class="datefinish">
                <h2>Seleccione fecha fin</h2>
                <input type="datetime-local" id="finish" min='2022-01-01 00:00'>
                <h4 id="invalidfinal" style="color:red; float: right; margin-right:10%; display: none">✖</h4>
                <h4 id="invalidfinaltext" style="display: none">La hora final debe ser posterior a la hora inicial.
                </h4>
                <br>
            </div>

        </header>
        <button id="serch" class="button3" style="margin: 0; position: absolute; left: 50%;">Buscar</button>
        <br>
        <br>
        <div id="formarea" style="display: none; margin: auto; justify-content: center;">
            <div class="button3">
                <label for="area">Área de búsqueda:</label><input type="range" id="area" name="area" min="1" max="20">
            </div>
            <div class="button3" id="searchedmarkersdiv">
                <label for="searchedmarkers">Ubicaciones en el área: </label><input type="range" id="searchedmarkers"
                    name="searchedmarkers" min="1">
            </div>
            <div style="float: right">
                <input type="button" id="hidepoly" value="Ocultar" style="display:none" class="button3">
            </div>
        </div>
        <br>
        <br>
        <div id="map" class="mapa"></div>
        </div>

        <div class="piepagin">
            <nav class="histo">
                <a href="index.html" class="button3">Volver a ubicación en tiempo real</a>
            </nav>
        </div>

        <script type="text/javascript">
            var polycolorline = "maroon";
            // Icon options for marker Inicio & Final
            var iconOptions = {
                iconUrl: '/images/marker.png',
                iconSize: [40, 40]
            }
            // Creating a custom icon
            var customIcon = L.icon(iconOptions);

            var date = new Date();
            var data = [null, null];
            data.length = 0;

            ini_fec = document.getElementById('start');
            fin_fec = document.getElementById('finish');


            var dayT = date.toISOString().slice(0, 10);

            hours = date.getHours();
            minu = date.getMinutes();
            if (minu < 10) {
                minu = "0" + minu;
            }
            if (hours < 10) {
                hours = "0" + hours;
            }
            var horaT = hours + ':' + minu;
            dayT = dayT + "T" + horaT;

            fin_fec.max = dayT;
            ini_fec.max = dayT;

            ini_fec.value = dayT;
            fin_fec.value = dayT;


            //calendario funcional
            ini_fec.addEventListener('click', function () {
                ini_fec.max = fin_fec.value;

            });

            fin_fec.addEventListener('click', function () {
                fin_fec.min = ini_fec.value;

            });

            // Verificación de que la fecha esté en el rango apropiado
            invalidinicial = document.getElementById('invalidinicial');
            invalidfinal = document.getElementById('invalidfinal');
            invalidinicialtext = document.getElementById('invalidinicialtext');
            invalidfinaltext = document.getElementById('invalidfinaltext');
            searchbutton = document.getElementById('serch');

            ini_fec.addEventListener('change', (event) => {
                if (ini_fec.value > fin_fec.value) {
                    invalidinicial.style.display = '';
                    invalidinicialtext.style.display = '';
                    invalidinicialtext.textContent = "La hora inicial debe ser anterior a la hora final.";
                    if (invalidfinal.style.display == '' && fin_fec.value <= dayT && fin_fec.value != '') {
                        invalidfinal.style.display = 'none';
                        invalidfinaltext.style.display = 'none';
                    }
                    serch.disabled = true;
                } else if (ini_fec.value > dayT) {
                    invalidinicial.style.display = '';
                    invalidinicialtext.style.display = '';
                    invalidinicialtext.textContent = "La fecha inicial debe ser anterior a la fecha/hora actual.";
                    serch.disabled = true;
                } else if (ini_fec.value == '') {
                    invalidinicial.style.display = '';
                    invalidinicialtext.style.display = '';
                    invalidinicialtext.textContent = "No se ha seleccionado una fecha adecuada.";
                    serch.disabled = true;
                }
                else {
                    invalidinicial.style.display = 'none';
                    invalidinicialtext.style.display = 'none';
                    if (fin_fec.value > dayT) {
                        invalidfinal.style.display = '';
                        invalidfinaltext.style.display = '';
                        invalidfinaltext.textContent = "La fecha final debe ser anterior a la fecha/hora actual.";
                    } else if (fin_fec.value == '') {
                        invalidfinal.style.display = '';
                        invalidfinaltext.style.display = '';
                        invalidfinaltext.textContent = "No se ha seleccionado una fecha adecuada.";
                    } else {
                        invalidfinal.style.display = 'none';
                        invalidfinaltext.style.display = 'none';
                    }
                    if (fin_fec.value > ini_fec.value && fin_fec.value <= dayT && fin_fec.value != '') {
                        serch.disabled = false;
                    }
                }
            });

            fin_fec.addEventListener('change', (event) => {
                if (fin_fec.value < ini_fec.value) {
                    invalidfinal.style.display = '';
                    invalidfinaltext.style.display = '';
                    invalidfinaltext.textContent = "La hora final debe ser posterior a la hora inicial.";
                    serch.disabled = true;
                    if (invalidinicial.style.display == '' && ini_fec.value <= dayT && ini_fec.value != '') {
                        invalidinicial.style.display = 'none';
                        invalidinicialtext.style.display = 'none';
                    }
                } else if (fin_fec.value > dayT) {
                    invalidfinal.style.display = '';
                    invalidfinaltext.style.display = '';
                    invalidfinaltext.textContent = "La fecha final debe ser anterior a la fecha/hora actual.";
                    if (ini_fec.value > dayT && ini_fec.value < fin_fec.value) {
                        invalidinicialtext.textContent = "La fecha inicial debe ser anterior a la fecha/hora actual.";
                    }
                    serch.disabled = true;
                } else if (fin_fec.value == '') {
                    invalidfinal.style.display = '';
                    invalidfinaltext.style.display = '';
                    invalidfinaltext.textContent = "No se ha seleccionado una fecha adecuada.";
                    serch.disabled = true;
                }
                else {
                    if (ini_fec.value > dayT) {
                        invalidinicial.style.display = '';
                        invalidinicialtext.style.display = '';
                        invalidinicialtext.textContent = "La fecha inicial debe ser anterior a la fecha/hora actual.";
                    } else if (ini_fec.value == '') {
                        invalidinicial.style.display = '';
                        invalidinicialtext.style.display = '';
                        invalidinicialtext.textContent = "No se ha seleccionado una fecha adecuada.";
                    }
                    else {
                        invalidinicial.style.display = 'none';
                        invalidinicialtext.style.display = 'none';
                    }
                    invalidfinal.style.display = 'none';
                    invalidfinaltext.style.display = 'none';
                    if (ini_fec.value < fin_fec.value && ini_fec.value <= dayT && ini_fec.value != '') {
                        serch.disabled = false;
                    }
                }
            });


            document.getElementById("serch").onclick = function () {
                if (formarea.style.display == 'flex') {
                    routine();
                    setTimeout(() => { routine(); }, 100);
                } else {
                    routine()
                }
            };

            //área
            area_drag = document.getElementById('area');
            area_drag.addEventListener('click', function () {
                if (hidepoly.style.display == 'none') { } else {
                    if (popLast != null) {
                        if (searchedarray.length == 0) {
                            if (noregpopup) {
                                noregpopup.remove();
                            }
                            var noregpopup = L.popup()
                                .setLatLng(circle._latlng)
                                .setContent('<b>No hay registro histórico en esta zona.</b>')
                                .openOn(map);
                        }
                        AreaUbicacionDrag();
                        InsideCircle();
                    }
                }
            });
            //markers search
            markers_drag = document.getElementById('searchedmarkers');
            markers_div = document.getElementById('searchedmarkersdiv');
            markers_drag.addEventListener('click', function () {
                AreaUbicacion();
                setTimeout(() => { InsideCircle(); }, 100);

            });

            //hidepoly
            hidepoly = document.getElementById('hidepoly');
            hidepoly.addEventListener('click', function () {
                if (hidepoly.value == "Ocultar") {
                    hidepoly.value = "Mostrar";
                    historicpoly();
                } else if (hidepoly.value == "Mostrar") {
                    hidepoly.value = "Ocultar";
                    fullpoly();
                }
            });


            function sendT() {

                //convertir dato
                var initdatesplit = ini_fec.value.split("T");
                var fechaini = initdatesplit[0];
                var horaini = initdatesplit[1];
                var finidatesplit = fin_fec.value.split("T");
                var fechafin = finidatesplit[0];
                var horafin = finidatesplit[1];

                $.ajax({
                    url: 'historicos.php',
                    type: 'post',
                    data: {
                        fechaini: fechaini,
                        fechafin: fechafin,
                        horaini: horaini,
                        horafin: horafin
                    }

                }).done(function (res) {
                    data = JSON.parse(res);
                })
            }

            var container = L.DomUtil.get("map"); //Mapa contendor

            if (container != null) {
                container._leaflet_id = null;
            }

            if (map) {
                map.invalidateSize(); // Si hay un mapa, lo elimina para recrearlo y que se pueda cambiar actualmente la posición ##
            }
            var marker = null, markerini = null, markerfin = null;
            markerini1 = null, markerfin1 = null, markerini2 = null, markerfin2 = null;
            window.polyline = [];
            window.polyline1 = [];
            window.polyline2 = [];
            var L = window.L;
            var trig = 1;

            var map = L.map("map").
                setView([10.99574, -74.79326],
                    16);

            L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data &copy; <a href="https://github.com/MSDR2022/Pagina2022">GPS Tracker</a>',
                maxZoom: 17
            }).addTo(map);

            L.control.scale().addTo(map);

            //form above map
            var abovemap = L.DomUtil.get('formarea'); // this must be an ID, not class!
            L.DomEvent.on(abovemap, 'mousewheel', L.DomEvent.stopPropagation);
            L.DomEvent.on(abovemap, 'click', L.DomEvent.stopPropagation);


            // Definir botón para elegir uno de los dos vehículos

            var stateSelectCar = L.easyButton({
                states: [{
                    stateName: 'selectCar1',        // name the state
                    icon: '<img src="/images/car1.png">',               // and define its properties
                    title: 'Vehículo #1',      // like its title
                    onClick: function (btn, map) {       // and its callback
                        if (formarea.style.display == 'flex') {
                            routine();
                            setTimeout(() => { routine(); }, 100);
                        } else {
                            routine()
                        }
                        btn.state('selectCar2');    // change state on click
                        polycolorline = "green";
                    }
                }, {
                    stateName: 'selectCar2',
                    icon: '<img src="/images/car2.png">',
                    title: 'Vehículo #2',
                    onClick: function (btn, map) {
                        if (formarea.style.display == 'flex') {
                            routine();
                            setTimeout(() => { routine(); }, 100);
                        } else {
                            routine()
                        }
                        btn.state('selectCar3');
                        polycolorline = "maroon";
                    }
                }, {
                    stateName: 'selectCar3',
                    icon: '<img src="/images/car3.png">',
                    title: 'Ambos vehículos',
                    onClick: function (btn, map) {
                        if (formarea.style.display == 'flex') {
                            routine();
                            setTimeout(() => { routine(); }, 100);
                        } else {
                            routine()
                        }
                        btn.state('selectCar1');
                    }
                }]
            });
            stateSelectCar.addTo(map);

            function historic() {
                if (data.length != 0) {
                    AreaUbicacion();
                }
                window.linearray = [];
                window.linearray1 = [];
                window.linearray2 = [];
                var LongitudHist = [];
                var LatitudHist = [];
                var FechaHist = [];
                var ID = [];
                if (window.data[0] == null && window.data[1] == null) { }
                else {
                    //console.log(linearray);
                    for (let i = 0; i < data.length; i++) {
                        if (data[i].ID == selectCarDecision) {
                            LongitudHist.push(data[i].Longitud);
                            LatitudHist.push(data[i].Latitud);
                            FechaHist.push(data[i].Fecha);
                            window.linearray.push([data[i].Latitud, data[i].Longitud]);
                        }

                    }

                    // console.log("linearray 2" + linearray);
                    for (let j = 1; j < 3; j++) {
                        if (markerini == null || markerini._mapToAdd == null || markerfin == null || markerfin._mapToAdd == null) {
                            markerini = L.marker([linearray[0][0], linearray[0][1]], { icon: customIcon }).addTo(map).bindPopup('<b> <center>' + "Inicio" + '</center>' + '<hr>' + '</b>' + '<br />' + '<b>' + FechaHist[0] + '</b>' + '<br />' + linearray[0][0] + ', ' + linearray[0][1]);

                            window.markerfinPopup = '<b> <center>' + "Final" + '</center>' + '</b>' + '<br />' + '<b> <center>' + FechaHist[linearray.length - 1] + '</center> </b>' + '<center>' + linearray[linearray.length - 1][0] + ', ' + linearray[linearray.length - 1][1] + '</center>';

                            window.markerfinPopup = '<b> <center>' + "Final" + '</center>' + '</b>' + '<br />' + '<b> <center>' + FechaHist[linearray.length - 1] + '</center> </b>' + '<center>' + linearray[linearray.length - 1][0] + ', ' + linearray[linearray.length - 1][1] + '</center>';

                            markerfin = L.marker([linearray[linearray.length - 1][0], linearray[linearray.length - 1][1]], { icon: customIcon }).addTo(map).bindPopup(window.markerfinPopup);
                            map.panTo(markerfin._latlng);

                        } else {
                            markerini.getPopup().setContent('<b> <center>' + "Inicio" + '</center>' + '<hr>' + '</b>' + '<br />' + '<b>' + FechaHist[0] + '</b>' + '<br />' + linearray[0][0] + ', ' + linearray[0][1]);
                            markerini.setLatLng([linearray[0][0], linearray[0][1]]);
                            window.markerfinPopup = '<b> <center>' + "Final" + '</center>' + '</b>' + '<br />' + '<b> <center>' + FechaHist[linearray.length - 1] + '</center> </b>' + '<center>' + linearray[linearray.length - 1][0] + ', ' + linearray[linearray.length - 1][1] + '</center>';
                            markerfin.getPopup().setContent(markerfinPopup);
                            markerfin.setLatLng([linearray[linearray.length - 1][0], linearray[linearray.length - 1][1]]);
                            map.panTo(markerfin._latlng);
                            //Polilinea
                            if (window.polyline != '') {
                                window.polyline.remove();
                            }
                            if (window.polyline1 != '' || window.polyline2 != '') {
                                window.polyline1.remove();
                                window.polyline2.remove();
                            }
                            window.polyline = L.polyline(window.linearray, { color: polycolorline }).addTo(map);
                        }
                    }
                }
                if (data.length != 0) { dialogBox(); }
            }

            function historic2() {
                if (data.length != 0) {
                    AreaUbicacion();
                }
                window.linearray1 = [];
                window.linearray2 = [];
                var FechaHist1 = [];
                var FechaHist2 = [];
                if (window.data[0] == null && window.data[1] == null) { }
                else {
                    //console.log(linearray);
                    for (let i = 0; i < data.length; i++) {
                        if (data[i].ID == 1) {
                            FechaHist1.push(data[i].Fecha);
                            window.linearray1.push([data[i].Latitud, data[i].Longitud]);
                        }
                        if (data[i].ID == 2) {
                            FechaHist2.push(data[i].Fecha);
                            window.linearray2.push([data[i].Latitud, data[i].Longitud]);
                        }
                    }

                    // console.log("linearray 2" + linearray); //
                    for (let j = 1; j < 3; j++) {
                        if (markerini1 == null || markerini1._mapToAdd == null || markerfin1 == null || markerfin1._mapToAdd == null) {
                            markerini1 = L.marker([linearray1[0][0], linearray1[0][1]], { icon: customIcon }).addTo(map).bindPopup('<b> <center>' + 'Vehículo 1' + '</center> </b>' + '<hr>' + '<b> <center>' + "Inicio" + '</center>' + '</b>' + '<br />' + '<b> <center>' + FechaHist1[0] + '</center> </b>' + '<br />' + '<center>' + linearray1[0][0] + ', ' + linearray1[0][1] + '</center>');
                            window.markerfin1Popup = '<b> <center>' + 'Vehículo 1' + '</center> </b>' + '<hr>' + '<b> <center>' + "Final" + '</center>' + '</b>' + '<br />' + '<b> <center>' + FechaHist1[linearray1.length - 1] + '</center> </b>' + '<center>' + linearray1[linearray1.length - 1][0] + ', ' + linearray1[linearray1.length - 1][1] + '</center>';
                            markerfin1 = L.marker([linearray1[linearray1.length - 1][0], linearray1[linearray1.length - 1][1]], { icon: customIcon }).addTo(map).bindPopup(window.markerfin1Popup);
                            markerini2 = L.marker([linearray2[0][0], linearray2[0][1]], { icon: customIcon }).addTo(map).bindPopup('<b> <center>' + 'Vehículo 2' + '</center> </b>' + '<hr>' + '<b> <center>' + "Inicio" + '</center>' + '</b>' + '<br />' + '<b> <center>' + FechaHist2[0] + '</center> </b>' + '<br />' + '<center>' + linearray2[0][0] + ', ' + linearray2[0][1] + '</center>');
                            window.markerfin2Popup = '<b> <center>' + 'Vehículo 2' + '</center> </b>' + '<hr>' + '<b> <center>' + "Final" + '</center>' + '</b>' + '<br />' + '<b> <center>' + FechaHist2[linearray2.length - 1] + '</center> </b>' + '<center>' + linearray2[linearray2.length - 1][0] + ', ' + linearray2[linearray2.length - 1][1] + '</center>';
                            markerfin2 = L.marker([linearray2[linearray2.length - 1][0], linearray2[linearray2.length - 1][1]], { icon: customIcon }).addTo(map).bindPopup(window.markerfin2Popup);
                            map.panTo(markerfin1._latlng);

                        } else {
                            markerini1.getPopup().setContent('<b> <center>' + 'Vehículo 1' + '</center> </b>' + '<hr>' + '<b> <center>' + "Inicio" + '</center>' + '</b>' + '<br />' + '<b> <center>' + FechaHist1[0] + '</center> </b>' + '<br />' + '<center>' + linearray1[0][0] + ', ' + linearray1[0][1] + '</center>');
                            markerini1.setLatLng([linearray1[0][0], linearray1[0][1]]);
                            window.markerfin1Popup = '<b> <center>' + 'Vehículo 1' + '</center> </b>' + '<hr>' + '<b> <center>' + "Final" + '</center>' + '</b>' + '<br />' + '<b> <center>' + FechaHist1[linearray1.length - 1] + '</center> </b>' + '<center>' + linearray1[linearray1.length - 1][0] + ', ' + linearray1[linearray1.length - 1][1] + '</center>';
                            markerfin1.getPopup().setContent(markerfin1Popup);
                            markerfin1.setLatLng([linearray1[linearray1.length - 1][0], linearray1[linearray1.length - 1][1]]);
                            markerini2.getPopup().setContent('<b> <center>' + 'Vehículo 2' + '</center> </b>' + '<hr>' + '<b> <center>' + "Inicio" + '</center>' + '</b>' + '<br />' + '<b> <center>' + FechaHist2[0] + '</center> </b>' + '<br />' + '<center>' + linearray2[0][0] + ', ' + linearray2[0][1] + '</center>');
                            markerini2.setLatLng([linearray2[0][0], linearray2[0][1]]);
                            window.markerfin2Popup = '<b> <center>' + 'Vehículo 2' + '</center> </b>' + '<hr>' + '<b> <center>' + "Final" + '</center>' + '</b>' + '<br />' + '<b> <center>' + FechaHist2[linearray2.length - 1] + '</center> </b>' + '<center>' + linearray2[linearray2.length - 1][0] + ', ' + linearray2[linearray2.length - 1][1] + '</center>';
                            markerfin2.getPopup().setContent(markerfin2Popup);
                            markerfin2.setLatLng([linearray2[linearray2.length - 1][0], linearray2[linearray2.length - 1][1]]);
                            map.panTo(markerfin1._latlng);
                            //Polilinea
                            if (window.polyline != '') {
                                window.polyline.remove();
                            }
                            if (window.polyline1 != '' || window.polyline2 != '') {
                                window.polyline1.remove();
                                window.polyline2.remove();
                            }
                            window.polyline1 = L.polyline(window.linearray1, { color: 'maroon' }).addTo(map);
                            window.polyline2 = L.polyline(window.linearray2, { color: 'green' }).addTo(map);
                        }
                    }
                }
                if (data.length != 0) { dialogBox(); }
            }

            window.popLast = null;
            var popLocation = null;

            function AreaUbicacion() {
                map.on('click', function (e) {
                    markers_div.style.display = "";
                    if (data.length != 0) {
                        if (popLast != null) {
                            map.removeLayer(window.circle);
                        }
                        var popLocation = e.latlng;
                        window.circle = new L.circle(popLocation, { radius: area.value * 100 });
                        map.addLayer(window.circle)
                        window.popLast = popLocation;
                        setTimeout(() => { InsideCircle(); }, 100);
                        hidepoly.style.display = "block";
                    }
                    if (hidepoly.value == "Mostrar") {
                        hidepoly.value = "Ocultar";
                        fullpoly();
                    }
                });
            }

            function AreaUbicacionDrag() {
                if (popLast != null) {
                    map.removeLayer(window.circle);
                }
                window.circle = new L.circle(popLast, { radius: area.value * 100 });
                map.addLayer(window.circle)

                setTimeout(() => { InsideCircle(); }, 100);
                if (hidepoly.value == "Mostrar") {
                    hidepoly.value = "Ocultar";
                    fullpoly();
                }
            }

            function InsideCircle() {
                window.searchedtime = [];
                window.searchedarray = [];
                window.searchedarray1 = [];
                window.searchedarray2 = [];
                window.searchedID = [];
                if (stateSelectCar._currentState.stateName == "selectCar3") {
                    for (let i = 0; i < window.data.length - 1; i++) {
                        if (window.data[i].ID == 1) {
                            if (map.distance(window.linearray1[i], window.circle._latlng) < area.value * 100) {
                                window.searchedtime.push(FechaHist1[i]);
                                window.searchedarray.push(window.linearray1[i]);
                                window.searchedarray1.push(window.linearray1[i]);
                            }
                        } else {
                            if (map.distance(window.linearray2[i], window.circle._latlng) < area.value * 100) {
                                window.searchedtime.push(FechaHist2[i]);
                                window.searchedarray.push(window.linearray2[i]);
                                window.searchedarray2.push(window.linearray2[i]);
                            }
                            window.searchedID.push(window.data[i].ID)
                        }
                    }
                } else {
                    for (let i = 0; i < window.linearray.length - 1; i++) {
                        if (map.distance(window.linearray[i], window.circle._latlng) < area.value * 100) {
                            window.searchedtime.push(window.data[i].Fecha);
                            window.searchedarray.push(window.linearray[i]);
                        }
                    }
                }
                markers_drag.max = searchedID.length - 1;
                nohistoric();
                InsideCircleMarkers();
            }

            function InsideCircleMarkers() {
                if (window.searchedarray.length != 0) {
                    if (stateSelectCar._currentState.stateName == "selectCar3") {
                        markerini1.remove();
                        markerfin1.remove();
                        markerini2.remove();
                        markerfin2.remove();
                        if (searchedID[markers_drag.value] == 1) { //id=1 cambiar
                            window.markerPopup = '<b> <center>' + "Vehículo 1" + '</center>' + '</b>' + '<br />' + '<b> <center>' + "Ubicación en el área" + '</center>' + '</b>' + '<br />' + '<b> <center>' + window.searchedtime[markers_drag.value] + '</center> </b>' + '<br />' + '<center>' + searchedarray[markers_drag.value] + '</center>';
                        } else {
                            window.markerPopup = '<b> <center>' + "Vehículo 2" + '</center>' + '</b>' + '<br />' + '<b> <center>' + "Ubicación en el área" + '</center>' + '</b>' + '<br />' + '<b> <center>' + window.searchedtime[markers_drag.value] + '</center> </b>' + '<br />' + '<center>' + searchedarray[markers_drag.value] + '</center>';
                        }
                    } else {
                        markerini.remove();
                        markerfin.remove();
                        window.markerPopup = '<b> <center>' + "Ubicación en el área" + '</center>' + '</b>' + '<br />' + '<b> <center>' + window.searchedtime[markers_drag.value] + '</center> </b>' + '<br />' + '<center>' + searchedarray[markers_drag.value] + '</center>';
                    }
                    if (marker != null) {
                        marker.remove();
                    }
                    marker = L.marker(searchedarray[markers_drag.value]).addTo(map).bindPopup(markerPopup).openPopup();
                    marker.closePopup();
                } else {
                    if (marker != null) {
                        marker.remove();
                    }
                    if (stateSelectCar._currentState.stateName == "selectCar3") {
                        markerini1.remove();
                        markerfin1.remove();
                        markerini2.remove();
                        markerfin2.remove();
                    } else {
                        markerini.remove();
                        markerfin.remove();
                    }
                }
                dialogBox();
            }

            function clearMap() {
                for (i in map._layers) {
                    if (map._layers[i]._path != undefined) {
                        try {
                            map.removeLayer(map._layers[i]);
                        }
                        catch (e) {
                            console.log("problem with " + e + map._layers[i]);
                        }
                    }
                }
            }
            
            function fullpoly() {
                if (stateSelectCar._currentState.stateName == "selectCar3") {
                    window.polyline1.remove();
                    window.polyline2.remove();
                    window.polyline1 = L.polyline(window.linearray1, { color: 'maroon' }).addTo(map);
                    window.polyline2 = L.polyline(window.linearray2, {color: 'green'}).addTo(map);
                } else {
                    window.polyline.remove();
                    window.polyline = L.polyline(window.linearray, { color: polycolorline }).addTo(map);
                }
            }

            function historicpoly() {
                if (stateSelectCar._currentState.stateName == "selectCar3") {
                    window.polyline1.remove();
                    window.polyline2.remove();
                    window.polyline1 = L.polyline(window.searchedarray1, { color: 'maroon' }).addTo(map);
                    window.polyline2 = L.polyline(window.searchedarray2, { color: 'green' }).addTo(map);
                } else {
                    window.polyline.remove();
                window.polyline = L.polyline(window.searchedarray, { color: polycolorline }).addTo(map);
            }
                }

            function nohistoric() {
                if (window.searchedarray.length == 0) {
                    window.markerPopup = '<br />' + '<br />' + '<b> <center>' + "No hay registro histórico en esta zona." + '</center>' + '</b>' + '<br />';
                }
            }

            window.popupDialog = "";
            var actualState = "";
            function dialogBox() {
                var options = {
                    size: [300, 160],
                    anchor: [0, 0],
                    position: "bottomright",
                    initOpen: true
                }
                if (stateSelectCar._currentState.stateName == "selectCar1") {
                    actualState = '<b> <center>' + 'Vehículo 1' + '</center> </b>' + '<hr>';
                } else if (stateSelectCar._currentState.stateName == "selectCar2") {
                    actualState = '<b> <center>' + 'Vehículo 2' + '</center> </b>' + '<hr>';
                } else {
                    actualState = "";
                }
                if (window.markerfin || window.marker) {
                    if (window.markerfin._mapToAdd != null) {
                        window.popupDialog = window.markerfinPopup;
                    } else {
                        window.popupDialog = window.markerPopup;
                    }
                }

                if (window.dialog) {
                    window.dialog.open();
                    window.dialog.setContent(actualState + popupDialog);
                } else {
                    window.dialog = L.control.dialog(options)
                        .setContent(actualState + popupDialog)
                        .addTo(map);
                    dialog.freeze();
                }

            }

            function routine() {
                if (stateSelectCar._currentState.stateName == "selectCar1") {
                    selectCarDecision = "1";
                } else if (stateSelectCar._currentState.stateName == "selectCar2") {
                    selectCarDecision = "2";
                }
                else {
                    selectCarDecision = "3";
                }
                markers_div.style.display = "none";
                hidepoly.style.display = "none";
                clearMap();
                sendT();
                if (window.dialog) {
                    window.dialog.close();
                }
                setTimeout(() => {
                    if (stateSelectCar._currentState.stateName == "selectCar3") {
                        historic2();
                    } else {
                        historic();
                    }
                }, 200);
                setTimeout(() => {
                    if (data.length != 0) {
                        formarea.style.display = "flex";
                    } else if (data.length == 0) {
                        formarea.style.display = "none";
                        if (markerini || markerfin) {
                            markerini.remove();
                            markerfin.remove();
                        }
                    }
                    if (marker != null) {
                        marker.remove();
                    }
                }, 200);

            }



        </script>

    </body>

    </html>