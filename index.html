<DOCTYPE html>
  <html lang="en" dir="ltr">

  <head>
    <meta charset="utf-8">
    <title>GPS Tracker</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

    <!-- Css de leaflet-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
      integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
      crossorigin="" />

    <!-- JS de leaflet-->
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
      integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
      crossorigin=""></script>

  </head>

  <body onload="table();" style="background-color:#28282B;">

    <table border=1 cellpadding=10>
      <!-- Se genera una tabla (la cual se entregara a index.php) -->
      <tr>
        <!-- Info de las columnas -->
        <td style="color:#FFFFFFFF">Latitud</td>
        <td style="color:#FFFFFFFF">Longitud</td>
        <td style="color:#FFFFFFFF">Fecha</td>
      </tr>
      <!-- Función FOR para crear columnas el valor $row es el nombre de la columna en SQL -->
      <tr>
        <td id="lat" style="color:#FFFFFFFF"></td>
        <td id="lng" style="color:#FFFFFFFF"></td>
        <td id="date" style="color:#FFFFFFFF"></td>
      </tr>

    </table>

    <div id="map" style="width: 100%; height: 85%;"></div>

    <script type="text/javascript">

      var container = L.DomUtil.get("map"); //Mapa contendor

      if (container != null) {
        container._leaflet_id = null;
      }

      if (map) {
        map.invalidateSize(); // Si hay un mapa, lo elimina para recrearlo y que se pueda cambiar actualmente la posición ##
      }
      var marker = null;
      var L = window.L;
      var trig = 1;

      var map = L.map("map").
        setView(["10.1010101", "-74.80808088"],
          16);

      L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://github.com/MSDR2022/Pagina2022">GPS Tracker</a>',
        maxZoom: 17
      }).addTo(map);

      L.control.scale().addTo(map);
      var linearray = [];
      function table() {
        const xhttp = new XMLHttpRequest();  //creando el objeto para trabajar
        xhttp.onload = function () {

          var data = this.responseText
          data = JSON.parse(data);
          document.getElementById("lat").innerHTML = data.Latitud
          document.getElementById("lng").innerHTML = data.Longitud
          document.getElementById("date").innerHTML = data.Fecha

          if (marker == null) {
            marker = L.marker([data.Latitud, data.Longitud]).addTo(map).bindPopup('<b>' + data.Fecha + '</b>' + '<br />' + data.Latitud + ' ' + data.Longitud).openPopup();

            if (trig == 1) {
              marker.getPopup().options.autoPan = false;
              map.setView([data.Latitud, data.Longitud], 16);
              trig = 2;
            } if (trig == 2) {
              marker.getPopup().options.autoPan = true;
            }

          } else {
            marker.getPopup().setContent('<b>' + data.Fecha + '</b>' + '<br />' + data.Latitud + ' ' + data.Longitud)
            marker.setLatLng([data.Latitud, data.Longitud]);
            //Polilinea
            linearray.push([data.Latitud, data.Longitud]);
            console.log(linearray)  //Revision de errores
            var polyline = L.polyline(linearray, { color: 'red' }).addTo(map);

          }

        }

        xhttp.open("GET", "datadb.php");  // documento que estamos llamando
        xhttp.send();
      }

      setInterval(function () {   //creamos un intervalo para realizar el mismo request del archivo que genera la conexión con la base de datos
        table();
      }, 5000); // Cada 5 segundos

    </script>
    <div>
      <table border=1 cellpadding=10>
        <!-- Se genera una tabla (la cual se entregara a index.php) -->
        <tr>
          <!-- Info de las columnas -->
          <td style="color:#FFFFFFFF">Latitud</td>
          <td style="color:#FFFFFFFF">Longitud</td>
          <td style="color:#FFFFFFFF">Fecha</td>
        </tr>

        <tr>
          <td id="lath" style="color:#FFFFFFFF"></td>
          <td id="lngh" style="color:#FFFFFFFF"></td>
          <td id="dateh" style="color:#FFFFFFFF"></td>
        </tr>

        <div id="map" style="width: 100%; height: 85%;"></div>

    <script type="text/javascript">

      var container = L.DomUtil.get("map"); //Mapa contendor

      if (container != null) {
        container._leaflet_id = null;
      }

      if (map) {
        map.invalidateSize(); // Si hay un mapa, lo elimina para recrearlo y que se pueda cambiar actualmente la posición ##
      }
      var marker = null;
      var L = window.L;
      var trig = 1;

      var map = L.map("map").
        setView(["10.1010101", "-74.80808088"],
          16);

      L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://github.com/MSDR2022/Pagina2022">GPS Tracker</a>',
        maxZoom: 17
      }).addTo(map);

      L.control.scale().addTo(map);
      var linearray = [];
      function tableh() {
        const xhttp = new XMLHttpRequest();  //creando el objeto para trabajar
        xhttp.onload = function () {

          var data = this.responseText
          data = JSON.parse(data);
          document.getElementById("lath").innerHTML = data.Latitud
          document.getElementById("lngh").innerHTML = data.Longitud
          document.getElementById("dateh").innerHTML = data.Fecha

          if (marker == null) {
            marker = L.marker([data.Latitud, data.Longitud]).addTo(map).bindPopup('<b>' + data.Fecha + '</b>' + '<br />' + data.Latitud + ' ' + data.Longitud).openPopup();

            if (trig == 1) {
              marker.getPopup().options.autoPan = false;
              map.setView([data.Latitud, data.Longitud], 16);
              trig = 2;
            } if (trig == 2) {
              marker.getPopup().options.autoPan = true;
            }

          } else {
            marker.getPopup().setContent('<b>' + data.Fecha + '</b>' + '<br />' + data.Latitud + ' ' + data.Longitud)
            marker.setLatLng([data.Latitud, data.Longitud]);
            //Polilinea
            linearray.push([data.Latitud, data.Longitud]);
            console.log(linearray)  //Revision de errores
            var polyline = L.polyline(linearray, { color: 'red' }).addTo(map);

          }

        }

        xhttp.open("GET", "historicos.php");  // documento que estamos llamando
        xhttp.send();
      }

      setInterval(function () {   //creamos un intervalo para realizar el mismo request del archivo que genera la conexión con la base de datos
        tableh();
      }, 1000); // Cada 5 segundos

    </script>

  </body>

  </html>